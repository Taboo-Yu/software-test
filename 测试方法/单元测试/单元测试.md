#                              单元测试

## 什么是单元测试？

> 单元测试是指，对软件中的最小可测试单元在与程序其他部分相隔离的情况下进行检查和验证的工作，这里的最小可测试单元通常是指函数或者类。

单元测试通常由开发工程师完成，一般会伴随开发代码一起递交至代码库。单元测试属于最严格的软件测试手段，是最接近代码底层实现的验证手段，可以在软件开发的早期以最小的成本保证局部代码的质量。

单元测试都是以自动化的方式执行，所以在大量回归测试的场景下更能带来高收益。

单元测试的实施过程还可以帮助开发工程师改善代码的设计与实现，并能在单元测试代码里提供函数的使用示例，因为单元测试的具体表现形式就是对函数以各种不同输入参数组合进行调用，这些调用方法构成了函数的使用说明。

## 如何做好单元测试？

1. 代码的基本特征与产生错误的原因

   > 要做到代码功能逻辑正确，必须做到分类正确并且完备无遗漏，同时每个分类的处理逻辑必须正确。

2. 单元用例测试详解

   > **单元测试的用例是一个“输入数据”和“预计输出”的集合。**
   >
   > **不是只有被测函数的输入参数是“输入数据”**，还有以下几种“输入数据”：
   >
   > - 被测试函数的输入参数
   > - 被测试函数内部需要读取的全局静态变量
   > - 被测试函数内部需要读取的成员变量
   > - 函数内部调用子函数获得的数据
   > - 函数内部调用子函数改写的数据
   > - 嵌入式系统中，在中断调用时改写的数据
   > - …
   >
   > “预计输出”不单单只有函数函数返回值，还应包括函数执行完成后改写的数据。具体如下几类：
   >
   > - 被测试函数的返回值
   > - 被测试函数的输出参数
   > - 被测试函数所改写的成员变量
   > - 被测试函数所改写的全局变量
   > - 被测试函数中进行的文件更新
   > - 被测试函数中进行的数据库更新
   > - 被测试函数中进行的消息队列更新
   > - …

   3. 驱动代码，桩代码和 Mock 代码

   > 驱动代码，桩代码和 Mock 代码,是单元测试中最常出现的三个名词，驱动代码是用来调用被测函数的，而桩代码和 Mock 代码是用来代替被测函数调用的真实代码的。
   >
   > ![驱动代码，桩代码和 Mock 代码三者的逻辑关系](https://static001.geekbang.org/resource/image/4b/2f/4b593086d9370bea9afc2d12219a0c2f.png)
   >
   > ######                                        驱动代码，桩代码和 Mock 代码三者的逻辑关系
   >
   > **驱动代码（Driver）指调用被测函数的代码**，在单元测试过程中，驱动模块通常包括调用被测函数前的数据准备、调用被测函数以及验证相关结果三个步骤。驱动代码的结构，通常由单元测试的框架决定。
   >
   > **桩代码（Stub）是用来代替真实代码的临时代码**。 比如，某个函数 A 的内部实现中调用了一个尚未实现的函数 B，为了对函数 A 的逻辑进行测试，那么就需要模拟一个函数 B，这个模拟的函数 B 的实现就是所谓的桩代码。
   >
   > **桩代码的应用首先起到了隔离和补齐的作用，使被测代码能够独立编译、链接，并独立运行。同时，桩代码还具有控制被测函数执行路径的作用。**
   >
   > 所以，编写桩代码通常需要遵守以下三个原则：
   >
   > - 桩函数要具有与原函数完全相同的原形，仅仅是内部实现不同，这样测试代码才能正确链接到桩函数；
   > - 用于实现隔离和补齐的桩函数比较简单，只需保持原函数的声明，加一个空的实现，目的是通过编译链接；
   > - 实现控制功能的桩函数是应用最广泛的，要根据测试用例的需要，输出合适的数据作为被测函数的内部输入。
   >
   > **Mock 代码和桩代码非常类似，都是用来代替真实代码的临时代码，起到隔离和补齐的作用。**
   >
   > Mock代码和桩代码区别：
   >
   > - 对于 Mock 代码来说，我们的关注点是 Mock 方法有没有被调用，以什么样的参数被调用，被调用的次数，以及多个 Mock 函数的先后调用顺序。所以，在使用 Mock 代码的测试中，对于结果的验证（也就是 assert），通常出现在 Mock 函数中。
   > - 对于桩代码来说，我们的关注点是利用 Stub 来控制被测函数的执行路径，不会去关注 Stub 是否被调用以及怎么样被调用。所以，你在使用 Stub 的测试中，对于结果的验证（也就是 assert），通常出现在驱动代码中。

   ## 实际项目中如何开展单元测试

   1. 并不是所有的代码都要进行单元测试，通常只有底层模块或者核心模块的测试中才会采用单元测试。
   2. 你需要确定单元测试框架的选型，这和开发语言直接相关。比如，Java 最常用的单元测试框架是 Junit 和 TestNG；C/C++ 最常用的单元测试框架是 CppTest 和 Parasoft C/C++test；框架选型完成后，你还需要对桩代码框架和 Mock 代码框架选型，选型的主要依据是开发所采用的具体技术栈。通常，单元测试框架、桩代码 /Mock 代码的选型工作由开发架构师和测试架构师共同决定。
   3. 为了能够衡量单元测试的代码覆盖率，通常你还需要引入计算代码覆盖率的工具。不同的语言会有不同的代码覆盖率统计工具，比如 Java 的 JaCoCo，JavaScript 的 Istanbul。在后续的文章中，我还会详细为你介绍代码覆盖率的内容。
   4. 最后你需要把单元测试执行、代码覆盖率统计和持续集成流水线做集成，以确保每次代码递交，都会自动触发单元测试，并在单元测试执行过程中自动统计代码覆盖率，最后以“单元测试通过率”和“代码覆盖率”为标准来决定本次代码递交是否能够被接受。

   

以上内容选自极客时间专栏《软件测试52讲》仅供学习参考